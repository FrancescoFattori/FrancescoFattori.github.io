<!DOCTYPE html>
<html>

<head>
    <title>UDP Test (geckos.io)</title>
</head>
<style>
    * {
        margin: 0
    }

    .player {
        width: 100px;
        height: 100px;
        position: absolute;
        background-color: red;
    }

    #ping {
        position: absolute;
        top: 0;
        right: 0;
        padding: 5px;
        font-family: Arial, sans-serif;
        font-size: 20px;
        z-index: 1;
    }
</style>

<body>
    <p id="ping"></p>
    <div id="player" class="player"></div>
    <div id="onlinePlayers"></div>
</body>
<script src="geckos.io-client.3.0.2.min.js"></script>
<script>
    //HTML
    var htmlPing = document.getElementById("ping");
    var htmlPlayer = document.getElementById("player"); htmlPlayer.style.top = "0px"; htmlPlayer.style.left = "0px";
    var htmlOnlinePlayers = document.getElementById("onlinePlayers");
    function addPlayer(p) {
        let elem = document.createElement("div");
        elem.className = "player"; elem.style.backgroundColor = p.color;
        elem.style.top = p.pos.y + "px"; elem.style.left = p.pos.x + "px";
        elem.id = p.id; htmlOnlinePlayers.appendChild(elem);
        p.html = elem; onlinePlayers.push(p);
    }
    function removePlayer(id) {
        for (let i = 0; i < onlinePlayers.length; i++) {
            if (onlinePlayers[i].id == id) {
                htmlOnlinePlayers.removeChild(onlinePlayers[i].html);
                onlinePlayers.splice(i, 1);
                break;
            }
        }
    }
    //Game
    var player = { html: htmlPlayer, pos: { x: 0, y: 0 }, color: "" }; var onlinePlayers = [];
    let color = new URL(window.location.href).searchParams.get("color");
    if (color != null) { player.color = color; htmlPlayer.style.backgroundColor = color; }
    //Inputs
    document.addEventListener("keydown", (e) => {
        switch (e.key) {
            case "w": player.pos.y -= 10; break;
            case "a": player.pos.x -= 10; break;
            case "s": player.pos.y += 10; break;
            case "d": player.pos.x += 10; break;
            default: return;
        }
        player.html.style.top = player.pos.y + "px"; player.html.style.left = player.pos.x + "px";
        client.emit("position", { x: player.pos.x, y: player.pos.y });
    });
    //Networking
    const client = geckos({url:"https://cinquolox.ddnsfree.com",port: 443 });
    client.onConnect(error => {
        if (error) { console.error(error.message); return; }
        client.emit("init", player);
        client.on("msg", (data) => {
            console.log("msg: " + data);
        });
        client.on("ping", (data) => {
            if (data != null) { ping.innerText = Math.round(data); }
            client.emit("pong");
        });
        client.on("addPlayer", (data) => {
            addPlayer(data);
        });
        client.on("players", (data) => {
            htmlOnlinePlayers.innerHTML = "";
            onlinePlayers = [];
            for (let p of data) addPlayer(p);
        });
        client.on("removePlayer", (data) => {
            removePlayer(data);
        });
        client.on("position", (data) => {
            for (let p of onlinePlayers) {
                if (p.id == data.id) {
                    p.html.style.top = data.y + "px";
                    p.html.style.left = data.x + "px";
                    break;
                }
            }
        });
    });
</script>

</html>